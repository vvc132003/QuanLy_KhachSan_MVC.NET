@model List<Model.Models.Modeldata>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<link rel='stylesheet'
      href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css'>
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<link href="~/content/static/morris.css" rel="stylesheet" />
<link href="~/content/static/c3.min.css" rel="stylesheet" />
<link href="~/content/static/style.css" rel="stylesheet" />
<link href="~/content/static/dashboard1.css" rel="stylesheet" />
<link href="~/css/kaiadmin.css" rel="stylesheet" />
@Html.Partial("~/Views/layout/logo.cshtml")
<link href="~/content/static/home.css" rel="stylesheet" />
<div class="skin-default-dark fixed-layout">
    <div id="main-wrapper">
        @Html.Partial("~/Views/layout/navbar.cshtml")
        @Html.Partial("~/Views/layout/header.cshtml")
        <div class="page-wrapper">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-2">
                        <div class="card card-stats card-round">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-icon">
                                        <div class="icon-big text-center icon-success bubble-shadow-small">
                                            <i class="fas fa-dollar-sign"></i>
                                        </div>
                                    </div>
                                    <div class="col col-stats ms-3 ms-sm-0">
                                        <div class="numbers">
                                            <p class="card-category">Doanh thu</p>
                                            <h4 class="card-title">
                                                @string.Format("{0:N0} VNĐ", @ViewData["tongDoanhThu"])
                                            </h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-2">
                        <div class="card card-stats card-round">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-icon">
                                        <div class="icon-big text-center icon-primary bubble-shadow-small">
                                            <i class="fas fa-users"></i>
                                        </div>
                                    </div>
                                    <div class="col col-stats ms-3 ms-sm-0">
                                        <div class="numbers">
                                            <p class="card-category">Khách hàng</p>
                                            <h4 class="card-title">@ViewData["tongSoLuongKhachHang"]</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-2">
                        <div class="card card-stats card-round">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-icon">
                                        <div class="icon-big text-center icon-info bubble-shadow-small">
                                            <i class="fas fa-comment"></i>
                                        </div>
                                    </div>
                                    <div class="col col-stats ms-3 ms-sm-0">
                                        <div class="numbers">
                                            <p class="card-category">Bình luận</p>
                                            <h4 class="card-title">@ViewData["tongbinhluan"]</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-2">
                        <div class="card card-stats card-round">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-icon">
                                        <div class="icon-big text-center icon-secondary bubble-shadow-small">
                                            <i class="fas fa-heart"></i>
                                        </div>
                                    </div>
                                    <div class="col col-stats ms-3 ms-sm-0">
                                        <div class="numbers">
                                            <p class="card-category">Likes</p>
                                            <h4 class="card-title">@ViewData["tonglikes"]</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-2">
                        <div class="card card-stats card-round">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-icon">
                                        <div class="icon-big text-center icon-warning bubble-shadow-small">
                                            <i class="fas fa-shopping-bag"></i>
                                        </div>
                                    </div>
                                    <div class="col col-stats ms-3 ms-sm-0">
                                        <div class="numbers">
                                            <p class="card-category">Sản phẩm</p>
                                            <h4 class="card-title">@ViewData["tongsanpham"]</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-2">
                        <div class="card card-stats card-round">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-icon">
                                        <div class="icon-big text-center  bubble-shadow-small" style="background:red;">
                                            <i class="fas fa-tags" style="color:white;"></i>
                                        </div>
                                    </div>
                                    <div class="col col-stats ms-3 ms-sm-0">
                                        <div class="numbers">
                                            <p class="card-category">Mã giảm giá</p>
                                            <h4 class="card-title">@ViewData["tongmagiamgia"]</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-8">
                        <div class="card mb-3">
                            <div class="card-header">
                                <div class="form-row">
                                    <div class="form-group col-md-4">
                                        <label for="startDate" class="sr-only">Start Date</label>
                                        <input type="date" class="form-control" id="startDate" />
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label for="endDate" class="sr-only">End Date</label>
                                        <input type="date" class="form-control" id="endDate" />
                                    </div>
                                    <div class="form-group col-md-4 mb-4 mb-md-0">
                                        <select class="form-control" id="idnam">
                                            <option value="" selected>Năm</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-4">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">Sản phẩm thuê %</div>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="pieChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-8">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">Doanh thu từng tháng</div>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="barChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card" style="height:94.3%;">
                            <div class="card-body">
                                <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d63536.63871717301!2d95.32870249999999!3d5.5611019!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3040377ae63dbcdf%3A0x3039d80b220cb90!2sBanda%20Aceh%2C%20Kota%20Banda%20Aceh%2C%20Aceh!5e0!3m2!1sid!2sid!4v1701054428265!5m2!1sid!2sid"
                                        width="600"
                                        height="450"
                                        style="border: 0; width: 100%"
                                        allowfullscreen=""
                                        loading="lazy"
                                        referrerpolicy="no-referrer-when-downgrade"></iframe>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="example" class="table table-striped table-bordered" style="width:100%">
                                        <thead>
                                            <tr>
                                                <th>Khách sạn</th>
                                                <th>Tên sản phẩm</th>
                                                <th>Số lượng thuê</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @if (Model.Count > 0)
                                            {
                                                foreach (var sanPham in Model)
                                                {
                                                    <tr>
                                                        <td>@sanPham.khachSan.tenkhachsan</td>
                                                        <td>@sanPham.sanPham.tensanpham</td>
                                                        <td>@sanPham.TotalRentedQuantity</td>
                                                    </tr>
                                                }
                                            }
                                            else
                                            {
                                                <tr>
                                                    <td colspan="12">Không có nhân viên nào!</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="col-8">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Số lượng thuê, chuyển, huỷ phòng theo tháng</div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="multipleLineChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
<script src="/static/custom.min.js"></script>
<script src="/static/jquery-3.2.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js"></script>
<script>
    $(document).ready(function () {
        $('#example').DataTable({
            "paging": true,
            "lengthChange": false,
            "searching": true,
            "ordering": false,
            "info": false,
            "autoWidth": false,
            "responsive": true,
            "pageLength": 5,
            "lengthMenu": [5, 10, 25, 50, 100],
            "language": {
                "paginate": {
                    "next": '<i class="fas fa-chevron-right"></i>',
                    "previous": '<i class="fas fa-chevron-left"></i>'
                },
                "search": "Tìm kiếm:",
            }
        });
    });
</script>
<script>

    function generateRandomColors(numColors) {
        var colors = [];
        for (var i = 0; i < numColors; i++) {
            var color = '#' + Math.random().toString(16).substr(-6);
            colors.push(color);
        }
        return colors;
    }
    $(document).ready(function () {
        var yearSelect = document.getElementById('idnam');
        var currentYear = new Date().getFullYear();
        for (var i = currentYear; i >= 1900; i--) {
            var option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            yearSelect.appendChild(option);
        }
        var myPieChart;
        function loadPieChart(startDate, endDate) {
            $.ajax({
                url: '/api/home/TongPhanTram',
                type: 'GET',
                data: { startDate: startDate, endDate: endDate },
                success: function (data) {
                    var chartData = data.map(item => item.tongdoanhthutungthang);
                    var labels = data.map(item => item.sanPham.tensanpham);
                    var backgroundColors = generateRandomColors(data.length);

                    var pieChart = document.getElementById('pieChart').getContext('2d');
                    if (myPieChart) {
                        myPieChart.destroy();
                    }
                    myPieChart = new Chart(pieChart, {
                        type: 'pie',
                        data: {
                            datasets: [{
                                data: chartData,
                                backgroundColor: backgroundColors,
                                borderWidth: 0
                            }],
                            labels: labels
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            legend: {
                                position: 'bottom',
                                labels: {
                                    fontColor: 'rgb(154, 154, 154)',
                                    fontSize: 11,
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            tooltips: {
                                enabled: true,
                                callbacks: {
                                    label: function (tooltipItem, data) {
                                        var dataset = data.datasets[tooltipItem.datasetIndex];
                                        var currentValue = dataset.data[tooltipItem.index];
                                        var total = dataset.data.reduce(function (previousValue, currentValue, currentIndex, array) {
                                            return previousValue + currentValue;
                                        });
                                        var percentage = Math.round((currentValue / total) * 100);
                                        return `${currentValue} (${percentage}%)`;
                                    }
                                },
                                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                                titleFontSize: 14,
                                titleFontColor: '#fff',
                                bodyFontColor: '#fff',
                                bodyFontSize: 12,
                                displayColors: false
                            },
                            pieceLabel: {
                                render: 'percentage',
                                fontColor: 'white',
                                fontSize: 14,
                                precision: 2,
                                overlap: true
                            },
                            layout: {
                                padding: {
                                    left: 20,
                                    right: 20,
                                    top: 20,
                                    bottom: 20
                                }
                            }
                        }
                    });
                },
                error: function (error) {
                    console.error('Error fetching pie chart data:', error);
                }
            });
        }

        var myBarChart;

        function loadBarChart(idnam) {
            $.ajax({
                url: '/api/home/DoanhThuTheoThang',
                type: 'GET',
                data: { idnam: idnam },
                success: function (data) {
                    var months = [
                        "Tháng 1", "Tháng 2", "Tháng 3", "Tháng 4", "Tháng 5", "Tháng 6",
                        "Tháng 7", "Tháng 8", "Tháng 9", "Tháng 10", "Tháng 11", "Tháng 12"
                    ];
                    var revenues = new Array(12).fill(0);

                    data.forEach(function (item) {
                        var payment = item.lichSuThanhToan;
                        var date = new Date(payment.ngaythanhtoan);
                        var month = date.getMonth(); // Lấy tháng (giá trị từ 0 - 11)
                        revenues[month] += payment.sotienthanhtoan; // Cộng dồn doanh thu theo tháng
                    });
                    var backgroundColors = generateRandomColors(months.length);

                    var barChartCanvas = document.getElementById("barChart");
                    var barChartContext = barChartCanvas.getContext("2d");

                    // Tạo biểu đồ mới
                    if (myBarChart) {
                        myBarChart.destroy(); // Hủy biểu đồ cũ nếu tồn tại
                    }
                    // Tạo biểu đồ mới
                    myBarChart = new Chart(barChartContext, {
                        type: "bar",
                        data: {
                            labels: months,
                            datasets: [{
                                label: "Tổng doanh thu",
                                backgroundColor: '#675584',
                                borderColor: "rgb(23, 125, 255)",
                                data: revenues,
                            }],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                yAxes: [{
                                    ticks: {
                                        beginAtZero: true,
                                    },
                                }],
                            },
                        },
                    });
                },
                error: function (error) {
                    console.error('Error fetching sales data:', error);
                }
            });
        }

        var myMultipleLineChart;
        function loadLineChart(idnam) {
            $.ajax({
                url: '/api/home/SoLuongHopDong',
                type: 'GET',
                data: { idnam: idnam },
                success: function (data) {
                    var datphongData = data.datphong;
                    var huydatphongData = data.huydatphong;
                    var chuyenphongData = data.chuyenphong;

                    var months = [
                        "Tháng 1", "Tháng 2", "Tháng 3", "Tháng 4", "Tháng 5", "Tháng 6",
                        "Tháng 7", "Tháng 8", "Tháng 9", "Tháng 10", "Tháng 11", "Tháng 12"
                    ];

                    var datasets = [];

                    // đặt phòng
                    var datphongDataset = {
                        label: 'Đặt phòng',
                        borderColor: '#1d7af3',
                        pointBorderColor: '#FFF',
                        pointBackgroundColor: '#1d7af3',
                        pointBorderWidth: 2,
                        pointHoverRadius: 4,
                        pointHoverBorderWidth: 1,
                        pointRadius: 4,
                        backgroundColor: 'transparent',
                        fill: true,
                        borderWidth: 2,
                        data: months.map(function (month, index) {
                            var foundMonth = datphongData.find(function (item) {
                                return item.month === index + 1;
                            });
                            return foundMonth ? foundMonth.count : 0;
                        }),
                    };
                    datasets.push(datphongDataset);

                    // huỷ
                    var huydatphongDataset = {
                        label: 'Huỷ đặt phòng',
                        borderColor: '#f3545d',
                        pointBorderColor: '#FFF',
                        pointBackgroundColor: '#f3545d',
                        pointBorderWidth: 2,
                        pointHoverRadius: 4,
                        pointHoverBorderWidth: 1,
                        pointRadius: 4,
                        backgroundColor: 'transparent',
                        fill: true,
                        borderWidth: 2,
                        data: months.map(function (month, index) {
                            var foundMonth = huydatphongData.find(function (item) {
                                return item.month === index + 1;
                            });
                            return foundMonth ? foundMonth.count : 0;
                        }),
                    };
                    datasets.push(huydatphongDataset);
                    // chuyển phòng
                    var chuyenphongDataset = {
                        label: 'Chuyển phòng',
                        borderColor: '#59d05d',
                        pointBorderColor: '#FFF',
                        pointBackgroundColor: '#59d05d',
                        pointBorderWidth: 2,
                        pointHoverRadius: 4,
                        pointHoverBorderWidth: 1,
                        pointRadius: 4,
                        backgroundColor: 'transparent',
                        fill: true,
                        borderWidth: 2,
                        data: months.map(function (month, index) {
                            var foundMonth = chuyenphongData.find(function (item) {
                                return item.month === index + 1;
                            });
                            return foundMonth ? foundMonth.count : 0;
                        }),
                    };
                    datasets.push(chuyenphongDataset);


                    var ctx = document.getElementById('multipleLineChart').getContext('2d');


                    if (myMultipleLineChart) {
                        myMultipleLineChart.destroy(); // Hủy biểu đồ cũ nếu tồn tại
                    }
                    myMultipleLineChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: datasets,
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            legend: {
                                position: 'top',
                            },
                            tooltips: {
                                bodySpacing: 4,
                                mode: 'nearest',
                                intersect: 0,
                                position: 'nearest',
                                xPadding: 10,
                                yPadding: 10,
                                caretPadding: 10,
                            },
                            layout: {
                                padding: { left: 15, right: 15, top: 15, bottom: 15 },
                            },
                        },
                    });
                },
                error: function (error) {
                    console.error('Error fetching line chart data:', error);
                }
            });
        }

        loadPieChart();
        loadBarChart();
        loadLineChart();


        $('#startDate, #endDate').on('change', function () {
            var startDate = $('#startDate').val();
            var endDate = $('#endDate').val();
            if (startDate && endDate) {
                loadPieChart(startDate, endDate);
            }
        });

        $('#idnam').on('change', function () {
            var idnam = $('#idnam').val();
            if (idnam > 0) {
                loadBarChart(idnam);
                loadLineChart(idnam);
            }
        });

    });
</script>